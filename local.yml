---
- name: Config
  hosts: localhost
  connection: local
  become: true # sudo

  tasks:
    - name: Install dependencies
      ansible.builtin.package:
        name:
          - git
          - gcc

    - name: Install cli programs
      ansible.builtin.package:
        name:
          - fzf
          - stow

    - name: Install latest neovim
      ansible.builtin.get_url:
        url: "https://github.com/neovim/neovim/releases/latest/download/nvim.appimage"
        dest: "{{ lookup('env', 'HOME') }}/.local/bin/nvim"
        mode: "0755"

    - name: Check if Rustup is installed
      ansible.builtin.command: "{{ lookup('env', 'HOME') }}/.cargo/bin/rustup --version"
      register: rustup_check
      ignore_errors: true
      changed_when: false

    - name: Debug output of rustup_check
      ansible.builtin.debug:
        var: rustup_check

    - name: Install Rustup if not installed
      become: true
      ansible.builtin.command: curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
      when: rustup_check is not defined
      register: rustup_install_output
      change_when: false

    - name: Print installation output
      ansible.builtin.debug:
        msg: "{{ rustup_install_output.stdout }}"
      when: rustup_install_output is defined and rustup_install_output.stdout is defined
